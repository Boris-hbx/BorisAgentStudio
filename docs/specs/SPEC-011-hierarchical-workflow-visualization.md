# SPEC-011: 分层工作流可视化

> 作者: Boris Huai
> 起草日期: 2026-01-25
> 状态: 草稿

---

## 1. 背景与动机

### 1.1 当前问题

当前 ToolCallFlow 组件将所有工具调用平铺展示，存在以下问题：

1. **信息过载**：20+ 工具调用一字排开，难以快速理解执行结构
2. **缺乏层次**：无法区分"探索阶段读了10个文件"和"执行阶段写了3个文件"
3. **丢失语义**：phase_annotations 仅作为小标签显示，未发挥分组作用

### 1.2 用户期望

> "我想要原来的那种分类的标签，模块化，然后点击看到里面'执行'工作流"

用户期望的是**两层结构**：
- **外层**：按阶段分组的模块化视图（概览）
- **内层**：展开后显示该阶段的工具调用详情

---

## 2. 设计目标

### 2.1 核心目标

1. **分层展示**：先看阶段概览，再看工具调用细节
2. **保持一致性**：v2.x 和 v3.0 数据格式使用统一的可视化逻辑
3. **按需展开**：默认只显示概览，点击阶段才展开详情，减少空间占用
4. **简洁优先**：未展开的阶段不占用垂直空间

### 2.2 非目标

- 不改变底层数据模型（STD-001 v3.0）
- 不强制要求所有 session 都有 phase_annotations

---

## 3. 数据模型映射

### 3.1 分组来源

| 数据格式 | 分组依据 | 说明 |
|---------|---------|------|
| v2.x | `phases[]` | 直接使用，每个 phase 是一个分组 |
| v3.0 | `phase_annotations[]` | 将标注转换为分组 |
| v3.0 (无标注) | 自动推断 | 基于工具类别自动分组（见 3.2） |

### 3.2 自动分组规则（当 phase_annotations 为空时）

根据工具调用的 `tool_category` 和时序特征自动推断阶段：

```
连续的 perception 调用 → 探索 (explore)
连续的 action 调用 → 执行 (execute)
planning 工具调用 → 规划 (plan)
最后的 perception 调用（如 tsc、test） → 验证 (verify)
```

自动分组标记 `confidence: 'low'`，提示用户这是推断结果。

### 3.3 统一分组结构

无论数据来源，最终转换为统一的 `PhaseGroup` 结构：

```typescript
interface PhaseGroup {
  group_id: string
  phase_type: PhaseType
  label: string

  // 统计信息（折叠时显示）
  tool_count: number
  duration_ms: number
  has_errors: boolean

  // 工具调用列表（展开时显示）
  tool_calls: ToolCall[]

  // 元信息
  source: 'phases' | 'annotations' | 'auto'
  confidence?: 'high' | 'medium' | 'low'
}
```

---

## 4. 页面布局设计

### 4.1 当前布局分析

```
┌─────────────────────────────────────────────────────────────────┐
│ Header (session 选择器、导入按钮)                                │
├─────────────────────────────────────────────────────────────────┤
│ StatusBar (进度、耗时、状态、工具调用次数)                       │
├─────────────────────────────────────────────┬───────────────────┤
│ app-main (flex: 1)                          │ DetailPanel       │
│ ┌─────────────────────────────────────────┐ │ (420px, 右侧)     │
│ │ Timeline (阶段概览)                      │ │                   │
│ │                                         │ │                   │
│ └─────────────────────────────────────────┘ │                   │
│ ┌─────────────────────────────────────────┐ │                   │
│ │ ContextFlowChart (下方统计图)            │ │                   │
│ │                                         │ │                   │
│ └─────────────────────────────────────────┘ │                   │
└─────────────────────────────────────────────┴───────────────────┘
```

### 4.2 布局方案推演

#### 方案 A：垂直展开 + 右侧工具详情（推荐）

```
┌─────────────────────────────────────────────────────────────────┐
│ Header                                                          │
├─────────────────────────────────────────────────────────────────┤
│ StatusBar                                                       │
├─────────────────────────────────────────────┬───────────────────┤
│ 主区域 (可滚动)                              │ ToolDetailPanel   │
│                                              │ (350px, 右侧)     │
│ ┌───────────────────────────────────────┐   │                   │
│ │ 阶段概览（固定高度 ~80px）            │   │ 点击工具节点时    │
│ │ [探索]──▶[执行]──▶[验证]──▶[执行]    │   │ 显示工具详情      │
│ │  5次     8次       3次      4次       │   │                   │
│ └───────────────────────────────────────┘   │ - 参数            │
│                                              │ - 输出            │
│ ┌───────────────────────────────────────┐   │ - 上下文贡献      │
│ │ 展开：探索                    [▲折叠] │   │                   │
│ │                                       │   │                   │
│ │ 📋 决策                               │   │                   │
│ │ ┌─────────────────────────────────┐   │   │                   │
│ │ │ [方案] xxx  理由: yyy           │   │   │                   │
│ │ └─────────────────────────────────┘   │   │                   │
│ │                                       │   │                   │
│ │ 📚 上下文                             │   │                   │
│ │ ┌─────────────────────────────────┐   │   │                   │
│ │ │ 🟡 CLAUDE.md    读取并修改      │   │   │                   │
│ │ │ 🟢 STD-001      读取并修改      │   │   │                   │
│ │ └─────────────────────────────────┘   │   │                   │
│ │                                       │   │                   │
│ │ 🔧 工具流                             │   │                   │
│ │ [R1]─▶[R2]─▶[R3]─▶[R4]─▶[R5]        │   │                   │
│ └───────────────────────────────────────┘   │                   │
│                                              │                   │
│ ┌───────────────────────────────────────┐   │                   │
│ │ 展开：执行                    [▲折叠] │   │                   │
│ │ ...                                   │   │                   │
│ └───────────────────────────────────────┘   │                   │
│                                              │                   │
└─────────────────────────────────────────────┴───────────────────┘
```

**优点**：
- 阶段概览始终可见（固定在顶部）
- 可同时展开多个阶段，垂直堆叠
- 右侧面板专注于单个工具的详情
- 主区域可滚动，适应任意数量的展开内容
- 保留用户熟悉的右侧详情面板模式

**缺点**：
- 多阶段展开时垂直滚动较多
- 工具流如果很长，需要水平滚动

**解决方案**：
- 工具流支持换行显示或水平滚动
- 提供"全部折叠"快捷操作

---

#### 方案 B：左侧列表 + 中间内容 + 右侧详情

```
┌─────────────────────────────────────────────────────────────────┐
│ Header                                                          │
├─────────────────────────────────────────────────────────────────┤
│ StatusBar                                                       │
├──────────┬──────────────────────────────────┬───────────────────┤
│ 阶段列表  │ 选中阶段内容                     │ 工具详情          │
│ (140px)  │ (flex: 1)                        │ (320px)           │
│          │                                  │                   │
│ ┌──────┐ │ 执行阶段                         │ #3 Write          │
│ │ 探索 │ │                                  │ 成功 · 60s        │
│ │ 5次  │ │ 📋 决策                          │                   │
│ └──────┘ │ [方案] 创建新组件...             │ 参数:             │
│ ┌──────┐ │                                  │ file_path: ...    │
│ │●执行│◀│ 📚 上下文                         │                   │
│ │ 8次  │ │ 🟡 CLAUDE.md                     │ 输出:             │
│ └──────┘ │ 🟢 STD-001                       │ Wrote 493 lines   │
│ ┌──────┐ │                                  │                   │
│ │ 验证 │ │ 🔧 工具流                        │ 上下文贡献:       │
│ │ 3次  │ │ [W1]─▶[W2]─▶[E1]─▶...          │ 核心变化...       │
│ └──────┘ │                                  │                   │
└──────────┴──────────────────────────────────┴───────────────────┘
```

**优点**：
- 三栏清晰分离
- 左侧阶段列表始终可见且紧凑
- 中间区域有足够空间展示内容

**缺点**：
- 同一时间只能查看一个阶段（不满足"同时展开多个"需求）
- 需要点击切换，无法对比

---

#### 方案 C：顶部概览 + 底部抽屉

```
┌─────────────────────────────────────────────────────────────────┐
│ Header                                                          │
├─────────────────────────────────────────────────────────────────┤
│ StatusBar                                                       │
├─────────────────────────────────────────────────────────────────┤
│ 阶段概览 (固定高度 ~100px)                                       │
│   [探索] ──▶ [执行] ──▶ [验证]                                  │
│    5次↓      8次↓       3次                                     │
├─────────────────────────────────────────────────────────────────┤
│ 展开区域 (可滚动)                                                │
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 探索  |  决策 · 上下文 · 工具流                             ││
│ └─────────────────────────────────────────────────────────────┘│
│ ┌─────────────────────────────────────────────────────────────┐│
│ │ 执行  |  决策 · 上下文 · 工具流                             ││
│ └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│ 工具详情抽屉 (底部弹出，~200px)                                  │
│ #3 Write  |  参数: {...}  |  输出: {...}  |  贡献: ...         │
└─────────────────────────────────────────────────────────────────┘
```

**优点**：
- 全宽利用，无右侧面板
- 底部抽屉不占用常驻空间

**缺点**：
- 底部抽屉会遮挡展开内容
- 需要滚动才能看到被遮挡部分
- 抽屉交互可能打断浏览流程

---

### 4.3 推荐方案：A（垂直展开 + 右侧工具详情）

选择理由：
1. 满足"点击哪个展开哪个，可同时展开多个"的需求
2. 保留用户熟悉的右侧详情面板
3. 阶段概览始终可见，不会迷失位置
4. 主区域滚动自然，无遮挡问题

### 4.4 空间分配

| 区域 | 宽度/高度 | 说明 |
|------|----------|------|
| Header | 100% × 56px | 固定高度 |
| StatusBar | 100% × 40px | 固定高度 |
| 阶段概览 | (100% - 350px) × 80px | 固定高度，横向滚动 |
| 展开区域 | (100% - 350px) × 自适应 | 垂直滚动 |
| ToolDetailPanel | 350px × 100% | 固定宽度，可折叠 |

### 4.5 响应式考虑

| 屏幕宽度 | 布局调整 |
|---------|---------|
| ≥ 1400px | 标准三栏布局 |
| 1200-1400px | ToolDetailPanel 缩至 300px |
| 900-1200px | ToolDetailPanel 变为底部抽屉 |
| < 900px | 单栏布局，所有详情用抽屉/模态 |

### 4.6 遮挡问题处理

| 场景 | 问题 | 解决方案 |
|------|------|---------|
| 多阶段展开 | 内容过长 | 主区域滚动，阶段概览固定 |
| 工具流过长 | 水平溢出 | 支持换行或水平滚动 |
| 工具详情面板打开 | 压缩主区域 | 面板固定宽度，主区域自适应 |
| 小屏幕 | 空间不足 | 面板改为抽屉/模态弹出 |

---

## 5. 可视化元素设计

### 5.1 阶段节点（PhaseNode）

**折叠状态**：

```
┌───────────────┐
│    探索       │  ← 阶段类型（带颜色）
│               │
│   5 calls     │  ← 工具调用数
│   2.1s        │  ← 总耗时
│   ● ● ● ○ ○   │  ← 工具类别分布（可选）
└───────────────┘
```

**展开状态**：

```
┌───────────────────────────────────────────────────────┐
│    探索                                    [折叠 ▲]   │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐│
│  │1 Read│──▶│2 Read│──▶│3 Grep│──▶│4 Read│──▶│5 Read││
│  └──────┘   └──────┘   └──────┘   └──────┘   └──────┘│
│                                                       │
│  点击工具节点查看详情                                  │
└───────────────────────────────────────────────────────┘
```

### 5.2 颜色编码

| 阶段 | 颜色 | 含义 |
|------|------|------|
| understand | `#8b5cf6` 紫色 | 理解用户意图 |
| explore | `#3b82f6` 蓝色 | 探索代码库 |
| plan | `#22c55e` 绿色 | 制定计划 |
| execute | `#f97316` 橙色 | 执行修改 |
| verify | `#ec4899` 粉色 | 验证结果 |
| mixed | `#6b7280` 灰色 | 混合/未分类 |

### 5.3 交互设计

| 操作 | 行为 |
|------|------|
| 单击阶段节点 | 展开/折叠该阶段（单选模式：同时只展开一个） |
| 单击工具节点 | 高亮并显示工具调用详情 |
| 悬停阶段节点 | 显示阶段描述 tooltip |
| 悬停工具节点 | 显示工具输入/输出摘要 |

### 5.4 关键信息展示（必须可见）

以下信息对理解 Agent 行为至关重要，**必须**在界面中清晰展示：

#### 5.4.1 阶段级信息（展开后显示）

```
┌─────────────────────────────────────────────────────────────────┐
│  执行                                              [折叠 ▲]     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📋 决策记录                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ [方案] 创建新组件 ToolCallFlow 而非修改 TimelineNode      │   │
│  │        理由：职责分离，工具调用流与阶段视图逻辑不同        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  📚 参考上下文                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🟡 CLAUDE.md              读取并修改                      │   │
│  │ 🟢 STD-001 标准           读取并修改                      │   │
│  │ 🟣 SPEC-003 规格          读取并修改                      │   │
│  │ 🟠 skill/commit.json      仅读取                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  🔧 工具调用流                                                  │
│  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐        │
│  │1 Read│──▶│2 Write│──▶│3 Write│──▶│4 Edit│──▶│5 Bash│        │
│  └──────┘   └──────┘   └──────┘   └──────┘   └──────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 5.4.2 上下文引用类型与颜色

| 类型 | 颜色 | 图标 | 示例 |
|------|------|------|------|
| claude_md | 🟡 金色 | 📜 | CLAUDE.md |
| rule | 🔵 蓝色 | 📏 | rules/RULE-001-*.md |
| standard | 🟢 绿色 | 📋 | standards/STD-001-*.md |
| skill | 🟠 橙色 | ⚡ | skills/SKILL-001-*.json |
| spec | 🟣 紫色 | 📐 | docs/specs/SPEC-001-*.md |
| file | ⚪ 灰色 | 📄 | 代码/配置文件 |
| capability | 🔷 青色 | 🧠 | 能力快照 |

#### 5.4.3 决策类型标签

| 类型 | 标签 | 说明 |
|------|------|------|
| approach | [方案] | 实现方案选择 |
| tool_selection | [工具] | 工具选择理由 |
| error_handling | [错误处理] | 错误应对策略 |
| skip | [跳过] | 跳过某步骤的理由 |
| retry | [重试] | 重试策略 |

#### 5.4.4 工具调用详情（点击工具节点后显示）

```
┌─────────────────────────────────────────────────────────────────┐
│  #3 Write                                          [关闭 ✕]    │
├─────────────────────────────────────────────────────────────────┤
│  类别: 行动 (action)                                            │
│  状态: ✅ 成功                                                  │
│  耗时: 60.0s                                                    │
│                                                                 │
│  描述: 更新 STD-001 至 v3.0                                     │
│                                                                 │
│  参数:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ file_path: "standards/data/STD-001-agent-session-..."   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  输出:                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Wrote 493 lines                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  上下文贡献:                                                    │
│  核心变化：tool_calls[] 必须，phase_annotations[] 可选          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 组件结构

### 6.1 组件树

```
Timeline.tsx
├── PhaseGroupList.tsx          # 阶段分组列表
│   ├── PhaseNode.tsx           # 单个阶段节点（可展开）
│   │   ├── PhaseHeader.tsx     # 阶段标题和统计
│   │   └── ToolCallList.tsx    # 展开后的工具调用列表
│   │       └── ToolCallNode.tsx # 单个工具调用节点
│   └── PhaseEdge.tsx           # 阶段间连接线
└── ToolCallDetail.tsx          # 工具调用详情面板
```

### 6.2 状态管理

```typescript
// sessionStore 新增
interface SessionState {
  // 现有...

  // 新增：展开的阶段组
  expandedGroupIds: Set<string>

  // 新增：选中的工具调用
  selectedToolCallId: string | null
}
```

---

## 7. 实现计划

### Phase 1: 数据转换层

1. 创建 `groupToolCalls.ts` 工具函数
2. 实现 v2.x phases → PhaseGroup 转换
3. 实现 v3.0 phase_annotations → PhaseGroup 转换
4. 实现自动分组算法

### Phase 2: 组件重构

1. 创建 `PhaseNode.tsx` 组件
2. 创建 `ToolCallList.tsx` 组件
3. 修改 `Timeline.tsx` 使用新组件
4. 移除或保留 `ToolCallFlow.tsx` 作为展开视图

### Phase 3: 交互完善

1. 实现展开/折叠动画
2. 实现工具调用选中高亮
3. 连接详情面板
4. 添加 tooltip

---

## 8. 向后兼容

- v2.x session：继续支持，phases 直接映射为 PhaseGroup
- v3.0 session：优先使用 phase_annotations，无则自动分组
- 现有 ToolCallFlow：可保留为"平铺视图"选项

---

## 9. 验收标准

1. [ ] v3.0 session 显示为阶段分组视图
2. [ ] 点击阶段节点可展开/折叠（支持同时展开多个）
3. [ ] 展开后显示：
   - [ ] 决策记录（decisions）及其理由
   - [ ] 参考上下文列表（context_used），带类型颜色和使用方式
   - [ ] 工具调用流
4. [ ] 工具调用节点可点击查看详情（参数、输出、上下文贡献）
5. [ ] 上下文引用按类型显示不同颜色（claude_md/rule/standard/skill/spec/file）
6. [ ] 自动分组时有"推断"标识（confidence: low）
7. [ ] v2.x session 保持兼容

---

## 10. 设计决策记录

| 决策 | 选择 | 理由 |
|------|------|------|
| 多阶段展开 | 允许同时展开多个 | 用户需要对比不同阶段 |
| 自动分组 | 基于工具类别 + 时序 | 实现简单，后续可迭代优化 |

---

## 附录 A: 参考设计

当前截图中底部的"构建→存储→检索→优化"流程可作为外层设计参考，但需要：
- 改为动态生成（基于实际 phase_annotations）
- 支持点击展开
- 显示更多统计信息（决策、上下文引用）
