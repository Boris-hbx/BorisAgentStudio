# RULE-004: 代码审查规范

> 版本: 1.0
> 作者: Boris Huai
> 创建日期: 2026-01-26
> 状态: 生效中

---

## 1. 概述

本规则定义 BorisAgentStudio 项目的代码审查流程、检查清单和最佳实践。

---

## 2. 审查原则

### 2.1 核心目标

- **代码质量**：确保代码可读、可维护
- **知识共享**：团队成员相互学习
- **错误预防**：在合并前发现问题
- **一致性**：保持代码风格统一

### 2.2 审查态度

- 对代码不对人
- 建设性反馈
- 解释"为什么"而非只说"不好"
- 承认多种正确解法

---

## 3. 审查清单

### 3.1 功能正确性

- [ ] 代码实现了 PR 描述中的功能
- [ ] 边界情况已处理
- [ ] 错误情况已处理
- [ ] 无明显 Bug

### 3.2 代码质量

- [ ] 遵循 STD-002 编码规范
- [ ] 函数/组件职责单一
- [ ] 命名清晰准确
- [ ] 无重复代码
- [ ] 无过度工程

### 3.3 可读性

- [ ] 代码结构清晰
- [ ] 复杂逻辑有注释
- [ ] 无魔法数字
- [ ] 类型定义完整

### 3.4 测试

- [ ] 新功能有对应测试
- [ ] 测试覆盖主要场景
- [ ] 测试可读且可维护
- [ ] 现有测试未被破坏

### 3.5 性能

- [ ] 无明显性能问题
- [ ] 无不必要的重新渲染
- [ ] 大数据量处理合理
- [ ] 无内存泄漏风险

### 3.6 安全

- [ ] 无敏感信息硬编码
- [ ] 用户输入已验证
- [ ] 无 XSS/注入风险
- [ ] 权限检查到位

### 3.7 文档

- [ ] 公共 API 有文档
- [ ] README 已更新 (如需要)
- [ ] 破坏性变更已记录

---

## 4. 审查流程

### 4.1 提交 PR

1. 确保 CI 通过
2. 填写 PR 模板
3. 指定审查者
4. 添加相关标签

### 4.2 审查响应时间

| 优先级 | 响应时间 |
|--------|----------|
| 紧急 (hotfix) | 2 小时内 |
| 高 (blocking) | 4 小时内 |
| 普通 | 1 工作日内 |
| 低 | 2 工作日内 |

### 4.3 审查过程

```
提交 PR → 自动 CI 检查 → 人工审查 → 反馈修改 → 批准 → 合并
    ↑                                    ↓
    └──────────── 迭代修改 ←─────────────┘
```

### 4.4 审查结果

| 结果 | 含义 |
|------|------|
| **Approve** | 代码可以合并 |
| **Request Changes** | 需要修改后重新审查 |
| **Comment** | 有建议但不阻止合并 |

---

## 5. 审查评论规范

### 5.1 评论前缀

| 前缀 | 含义 | 是否阻止合并 |
|------|------|-------------|
| `[blocker]` | 必须修复 | 是 |
| `[suggestion]` | 建议改进 | 否 |
| `[question]` | 需要解释 | 视情况 |
| `[nit]` | 细节/风格 | 否 |
| `[praise]` | 赞扬好代码 | - |

### 5.2 评论示例

```markdown
[blocker] 这里缺少空值检查，当 `session` 为 undefined 时会崩溃：

```tsx
// 当前代码
const name = session.name

// 建议修改
const name = session?.name ?? 'Unknown'
```

---

[suggestion] 这个逻辑可以提取为自定义 Hook，提高复用性：

```tsx
// 可以考虑
const { isExpanded, toggle } = useExpandable()
```

---

[nit] 这里的变量名可以更具描述性：
`d` → `duration` 或 `durationMs`

---

[praise] 这个错误处理写得很好，覆盖了所有边界情况！
```

### 5.3 避免的评论

```markdown
# ❌ 不推荐
"这代码不好"
"为什么这样写？"
"改掉"

# ✅ 推荐
"[suggestion] 这段代码可以简化，因为..."
"[question] 这里选择 X 而不是 Y 的原因是？"
"[blocker] 请修改为 Y，因为 X 会导致..."
```

---

## 6. 作者响应规范

### 6.1 响应态度

- 感谢审查者的时间
- 认真对待每条反馈
- 解释你的决策理由
- 承认并修复问题

### 6.2 响应方式

| 反馈类型 | 响应方式 |
|----------|----------|
| 同意修改 | 修改代码，回复 "Fixed" |
| 需要讨论 | 解释原因，等待审查者回复 |
| 不同意 | 礼貌说明理由，寻求共识 |

### 6.3 解决评论

- 修改后将评论标记为 "Resolved"
- 如有分歧，可请第三方仲裁
- 所有 blocker 必须解决后才能合并

---

## 7. 特殊情况

### 7.1 紧急修复

- 可以减少审查要求
- 事后补充完整审查
- 记录为什么跳过常规流程

### 7.2 大型 PR

- 超过 500 行应考虑拆分
- 提供审查指南
- 分阶段审查

### 7.3 自动化审查

以下由 CI 自动检查，人工审查可跳过：

- 代码格式 (Prettier/rustfmt)
- Lint 错误 (ESLint/Clippy)
- 类型检查 (TypeScript)
- 测试通过

---

## 8. 工具支持

### 8.1 GitHub 功能

- **Required Reviews**: 设置必须通过的审查数量
- **CODEOWNERS**: 自动分配审查者
- **Branch Protection**: 保护主分支

### 8.2 CODEOWNERS 配置

```
# .github/CODEOWNERS

# 默认审查者
*                   @BorisHuai

# 前端代码
/frontend/          @BorisHuai
/frontend/src/components/  @BorisHuai

# 后端代码
/backend/           @BorisHuai

# 文档
/docs/              @BorisHuai
*.md                @BorisHuai

# 配置文件
/standards/         @BorisHuai
/rules/             @BorisHuai
```

---

## 9. 度量与改进

### 9.1 跟踪指标

- PR 平均审查时间
- 审查迭代次数
- 合并后发现的问题数

### 9.2 定期回顾

- 月度回顾审查效果
- 识别常见问题模式
- 更新检查清单

---

## 10. 相关文档

- [RULE-003](./RULE-003-git-commit-standards.md) - Git 提交规范
- [STD-002](../../standards/coding/STD-002-coding-standards.md) - 编码规范
- [STD-004](../../standards/testing/STD-004-testing-standards.md) - 测试规范
