# SPEC-002: 可视化界面设计

> 作者: Boris Huai
> 起草日期: 2026-01-24
> 状态: 实施中

---

## 设计目标

本规格定义 BorisAgentStudio 的可视化界面设计。

核心原则：**可视化服务于认知，不是装饰**。

每个视觉元素必须回答至少一个问题：
- Agent 当时在做什么？
- 它为什么这么做？
- 如果失败，失败与哪一层知识或上下文有关？

---

## MVP 范围界定

### 本规格包含（v0.1）

| 模块 | 优先级 | 说明 |
|------|--------|------|
| 全局流程时序图 | P0 | 核心视图，必须实现 |
| 步骤详情面板 | P0 | 点击步骤展示详情 |
| 领域知识关联标识 | P0 | 展示知识来源与匹配度 |
| 实时状态指示器 | P1 | 顶部状态栏 |
| 上下文流转简图 | P1 | 简化版，与时序图联动 |

### 本规格不包含（推迟至 v0.2+）

| 模块 | 推迟原因 |
|------|----------|
| 技能矩阵雷达图 | MVP 聚焦流程理解，技能分析为进阶功能 |
| 记忆分层视图 | 需要真实 Agent 数据支撑 |
| 配置文件关联视图 | 需要与真实 Agent 对接 |
| 知识上传与重执行 | 需要 Agent 运行时支持 |
| 架构视图切换 | MVP 只做时序视图 |

---

## 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│  [Logo] Boris Agent Studio          [状态指示器]    [Session选择] │  ← 顶部控制栏
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   全局流程时序图                          │   │  ← 核心区域 (70%)
│  │   [需求] → [拆解] → [生成] → [执行] → [修复] → [验证] → [沉淀] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   上下文流转简图                          │   │  ← 联动区域 (30%)
│  │            构建 ──→ 存储 ──→ 检索 ──→ 优化               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                        步骤详情面板                              │  ← 底部详情 (可折叠)
└─────────────────────────────────────────────────────────────────┘
```

### 布局原则

1. **单页全景**：无页面跳转，所有信息在一页内呈现
2. **渐进披露**：核心信息常驻，详细信息按需展开
3. **响应式**：大屏完整展示，小屏隐藏上下文流转区域

---

## 模块一：全局流程时序图（P0）

### 视觉结构

```
     ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐
     │需求 │───▶│拆解 │───▶│生成 │───▶│执行 │───▶│修复 │───▶│验证 │───▶│沉淀 │
     │输入 │    │任务 │    │代码 │    │环境 │    │调试 │    │结果 │    │记忆 │
     └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘
        │          │          │          │          │          │          │
       ○○        ○●○       ●●○        ○          ○          ○          ○

       └── 领域知识关联标识（见下文）
```

### 节点状态设计

| 状态 | 视觉表现 | 行为 |
|------|----------|------|
| pending | 灰色边框，淡色填充 | 折叠，仅显示名称 |
| running | 蓝色边框，脉冲动画 | 展开，显示实时信息 |
| success | 绿色边框，实色填充 | 自动折叠，可手动展开 |
| failed | 红色边框，红色填充 | 保持展开，显示错误 |
| skipped | 虚线边框，灰色填充 | 折叠，显示跳过原因 |

### 节点展开态内容

```
┌─────────────────────────────────────┐
│  代码生成                     ✓ 成功  │  ← 标题 + 状态
├─────────────────────────────────────┤
│  耗时: 500ms                        │
│  ─────────────────────────────────  │
│  输入: 4 个子任务                    │
│  输出: Python 代码 (23行)            │
│  ─────────────────────────────────  │
│  技能: Python 代码生成               │
│  ─────────────────────────────────  │
│  领域知识匹配度: 88%                 │
│  ● 斐波那契定义 (0.95)               │
│  ● Python迭代优化 (0.80)             │
│  ─────────────────────────────────  │
│  [查看详情]                          │
└─────────────────────────────────────┘
```

### 领域知识关联标识

每个步骤节点下方显示圆点标识，表示领域知识来源：

| 颜色 | 来源 | 说明 |
|------|------|------|
| 橙色 ● | .skill 文件 | 高频结构化规则 |
| 紫色 ● | 知识图谱 | 复杂关联知识 |
| 绿色 ● | 临时读取 | 一次性信息 |
| 灰色 ○ | 无 | 该步骤未使用领域知识 |

**交互**：鼠标悬浮显示知识片段摘要

### 交互规则

1. **点击节点**：展开/折叠该步骤详情
2. **双击节点**：打开完整详情面板
3. **锁定功能**：点击锁定图标，防止自动折叠
4. **连接线**：
   - 实线：正常流转
   - 虚线：跳过的步骤
   - 红色线：失败后的路径

---

## 模块二：步骤详情面板（P0）

### 触发方式

- 双击时序图节点
- 点击节点内「查看详情」按钮

### 面板结构

```
┌─────────────────────────────────────────────────────────────────┐
│  步骤详情：代码生成                                    [×] 关闭  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │    输入     │  │    输出     │  │  领域知识   │             │  ← Tab 切换
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │  def fibonacci(n: int) -> int:                          │   │
│  │      if n <= 0:                                         │   │
│  │          raise ValueError('n must be positive')         │   │
│  │      if n <= 2:                                         │   │
│  │          return 1                                       │   │
│  │      a, b = 1, 1                                        │   │
│  │      for _ in range(n - 2):                             │   │
│  │          a, b = b, a + b                                │   │
│  │      return b                                           │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  元数据                                                  │   │
│  │  ─────────────────────────────────────────────────────  │   │
│  │  step_id: step-003                                      │   │
│  │  timestamp: 2026-01-24T10:00:05Z                        │   │
│  │  duration: 500ms                                        │   │
│  │  context_link: step-002                                 │   │
│  │  domain_matching_score: 0.88                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [复制输出]  [查看上下文链]                                      │
└─────────────────────────────────────────────────────────────────┘
```

### Tab 内容定义

| Tab | 内容 |
|-----|------|
| 输入 | 格式化的 input 数据，支持 JSON 折叠 |
| 输出 | 代码高亮显示，或结构化数据展示 |
| 领域知识 | 关联的知识条目列表，含匹配度和原文摘要 |

### 失败步骤额外展示

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️ 失败原因                                                    │
├─────────────────────────────────────────────────────────────────┤
│  错误类型: SyntaxError                                          │
│  错误信息: unexpected indent at line 5                          │
│  ─────────────────────────────────────────────────────────────  │
│  诊断建议:                                                       │
│  • 领域知识匹配度: 0.32 (低于阈值 0.6)                           │
│  • 可能缺少: Python 缩进规范相关知识                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 模块三：实时状态指示器（P1）

### 位置

顶部控制栏下方，始终可见

### 内容

```
┌─────────────────────────────────────────────────────────────────┐
│  进度: ████████░░░░ 5/7 (71%)  │  耗时: 1.2s  │  当前: 调试修复  │  知识匹配: 0.85  │
└─────────────────────────────────────────────────────────────────┘
```

| 指标 | 说明 |
|------|------|
| 进度 | 已完成步骤数 / 总步骤数 |
| 总耗时 | 累计执行时间 |
| 当前步骤 | 正在执行的步骤名称 |
| 知识匹配 | 全局领域知识匹配度均值 |

---

## 模块四：上下文流转简图（P1）

### 视觉结构

```
        构建              存储              检索              优化
    ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
    │ 原始需求 │ ───▶ │ 工作记忆 │ ───▶ │ 知识检索 │ ───▶ │ 上下文  │
    │ 任务分解 │      │ 技能缓存 │      │ 历史案例 │      │ 压缩    │
    └─────────┘      └─────────┘      └─────────┘      └─────────┘
         ↑                                 ↑
         │                                 │
    ─────┴─────────────────────────────────┴───── 当前步骤关联
```

### 联动规则

1. **展开步骤时**：高亮对应的上下文阶段
2. **领域知识注入**：在「检索」阶段标注知识来源
3. **上下文压缩**：在「优化」阶段显示压缩率（如有）

### MVP 简化

- 仅展示四阶段图示
- 联动高亮通过 CSS 类切换实现
- 不展示详细的上下文内容（推迟到 v0.2）

---

## 视觉设计规范

### 颜色系统

```css
/* 状态颜色 */
--status-pending: #6b7280;    /* 灰色 */
--status-running: #3b82f6;    /* 蓝色 */
--status-success: #22c55e;    /* 绿色 */
--status-failed: #ef4444;     /* 红色 */
--status-skipped: #9ca3af;    /* 浅灰 */

/* 领域知识来源 */
--knowledge-skill: #f97316;   /* 橙色 - .skill 文件 */
--knowledge-graph: #a855f7;   /* 紫色 - 知识图谱 */
--knowledge-temp: #22c55e;    /* 绿色 - 临时读取 */

/* 上下文流转 */
--context-flow: #f97316;      /* 橙色 */

/* 背景 */
--bg-primary: #0d1117;
--bg-secondary: #161b22;
--bg-tertiary: #21262d;

/* 文字 */
--text-primary: #c9d1d9;
--text-secondary: #8b949e;

/* 边框 */
--border-default: #30363d;
```

### 字体

- 标题: system-ui, -apple-system, sans-serif
- 代码: 'Fira Code', 'JetBrains Mono', monospace
- 中文: 'PingFang SC', 'Microsoft YaHei', sans-serif

### 动画

| 场景 | 动画 | 时长 |
|------|------|------|
| 节点展开/折叠 | ease-out | 200ms |
| 状态切换 | ease-in-out | 150ms |
| 运行中脉冲 | pulse | 1.5s 循环 |
| 连接线流动 | dash-offset | 2s 循环 |

### 响应式断点

| 断点 | 布局调整 |
|------|----------|
| ≥1200px | 完整布局 |
| 800-1199px | 隐藏上下文流转图 |
| <800px | 单列布局，Tab 切换区域 |

---

## 数据流设计

### 初始化流程

```
1. 前端加载 → 请求 Session 列表
2. 用户选择 Session → 请求完整 Session 数据
3. 渲染时序图（初始状态：全部折叠）
4. 建立 WebSocket 连接
5. 接收实时更新 → 更新对应节点状态
```

### WebSocket 事件

| 事件 | 触发时机 | 前端行为 |
|------|----------|----------|
| step_update | 步骤状态变化 | 更新节点状态，展开 running 节点 |
| session_complete | Session 执行完成 | 折叠所有节点，显示完成提示 |

### 数据映射

```typescript
// 后端 AgentStep → 前端节点
{
  step_id        → node.id
  step_name      → node.label + node.type
  status         → node.status (决定颜色和展开状态)
  input/output   → node.content (详情面板)
  context_link   → edge.source (连接线)
  skill_source   → node.skill (技能标签)
  domain_knowledge_source → node.knowledgeMarkers (圆点标识)
  domain_matching_score   → node.matchScore (匹配度)
}
```

---

## 组件拆分建议

```
src/
├── components/
│   ├── Layout/
│   │   ├── Header.tsx              # 顶部控制栏
│   │   └── StatusBar.tsx           # 状态指示器
│   ├── Timeline/
│   │   ├── Timeline.tsx            # 时序图容器
│   │   ├── TimelineNode.tsx        # 步骤节点
│   │   ├── TimelineEdge.tsx        # 连接线
│   │   └── KnowledgeMarkers.tsx    # 知识标识点
│   ├── ContextFlow/
│   │   └── ContextFlowChart.tsx    # 上下文流转图
│   ├── DetailPanel/
│   │   ├── DetailPanel.tsx         # 详情面板容器
│   │   ├── InputTab.tsx            # 输入 Tab
│   │   ├── OutputTab.tsx           # 输出 Tab
│   │   └── KnowledgeTab.tsx        # 知识 Tab
│   └── common/
│       ├── CodeBlock.tsx           # 代码高亮
│       └── JsonViewer.tsx          # JSON 展示
├── visualizations/
│   ├── d3Timeline.ts               # D3 时序图逻辑
│   └── d3ContextFlow.ts            # D3 上下文流转图逻辑
└── hooks/
    ├── useSession.ts               # Session 数据管理
    └── useWebSocket.ts             # WebSocket 连接
```

---

## 实现优先级

### Phase 1：骨架搭建

1. 布局组件 (Header, StatusBar)
2. 时序图基础渲染 (7 个静态节点)
3. Mock 数据加载

### Phase 2：核心交互

4. 节点展开/折叠
5. 状态颜色映射
6. 详情面板基础版

### Phase 3：可视化增强

7. 领域知识标识
8. 上下文流转图
9. WebSocket 实时更新

### Phase 4：打磨

10. 动画效果
11. 响应式适配
12. 边缘情况处理

---

## 开放问题

以下问题需要在实现过程中验证，可能触发 Spec 演进：

1. **时序图布局算法**：横向固定布局 vs 自适应布局？
2. **详情面板位置**：底部固定 vs 右侧抽屉 vs 弹窗？
3. **上下文流转图**：是否值得在 MVP 中实现？
4. **领域知识匹配度阈值**：0.6 是否合理？

---

## 相关文档

- [SPEC-001: 项目总览](./SPEC-001-project-overview.md)
- [CLAUDE.md](../../CLAUDE.md)
